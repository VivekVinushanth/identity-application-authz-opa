<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>InvokeOpaFunctionImpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Imply OPA related functions</a> &gt; <a href="index.source.html" class="el_package">org.wso2.carbon.identity.conditional.auth.functions.opa</a> &gt; <span class="el_source">InvokeOpaFunctionImpl.java</span></div><h1>InvokeOpaFunctionImpl.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 2020, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.
 *
 * WSO2 Inc. licenses this file to you under the Apache License,
 * Version 2.0 (the &quot;License&quot;); you may not use this file except
 * in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an
 * &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 * KIND, either express or implied.  See the License for the
 * specific language governing permissions and limitations
 * under the License.
 */
package org.wso2.carbon.identity.conditional.auth.functions.opa;

import org.apache.commons.lang.StringUtils;
import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;
import org.apache.http.client.config.RequestConfig;
import org.apache.http.client.methods.CloseableHttpResponse;
import org.apache.http.client.methods.HttpPost;
import org.apache.http.conn.ConnectTimeoutException;
import org.apache.http.entity.StringEntity;
import org.apache.http.impl.client.CloseableHttpClient;
import org.apache.http.impl.client.HttpClientBuilder;
import org.apache.http.util.EntityUtils;
import org.json.simple.JSONObject;
import org.json.simple.parser.JSONParser;
import org.json.simple.parser.ParseException;
import org.wso2.carbon.identity.application.authentication.framework.AsyncProcess;
import org.wso2.carbon.identity.application.authentication.framework.config.model.graph.JsGraphBuilder;
import org.wso2.carbon.identity.application.authentication.framework.config.model.graph.js.*;
import org.wso2.carbon.identity.application.authentication.framework.util.FrameworkConstants;
import org.wso2.carbon.identity.claim.metadata.mgt.exception.ClaimMetadataException;
import org.wso2.carbon.identity.claim.metadata.mgt.model.LocalClaim;
import org.wso2.carbon.identity.conditional.auth.functions.common.utils.Constants;
import org.wso2.carbon.identity.conditional.auth.functions.opa.internal.OPAFunctionsServiceHolder;
import org.wso2.carbon.identity.conditional.auth.functions.opa.util.OPAConstants;

import java.io.IOException;
import java.net.SocketTimeoutException;
import java.util.*;

import static org.apache.http.HttpHeaders.ACCEPT;
import static org.apache.http.HttpHeaders.CONTENT_TYPE;

/**
 * Implementation of the {@link InvokeOpaFunction}
 */
public class InvokeOpaFunctionImpl implements InvokeOpaFunction {

<span class="nc" id="L56">    private static final Log LOG = LogFactory.getLog(InvokeOpaFunctionImpl.class);</span>
    private static final String TYPE_APPLICATION_JSON = &quot;application/json&quot;;

    private CloseableHttpClient client;

    public CloseableHttpClient getClient() {
<span class="nc" id="L62">        return client;</span>
    }

    public void setClient(CloseableHttpClient client) {
<span class="nc" id="L66">        this.client = client;</span>
<span class="nc" id="L67">    }</span>

<span class="nc" id="L69">    public InvokeOpaFunctionImpl() {</span>

<span class="nc" id="L71">        RequestConfig config = RequestConfig.custom()</span>
<span class="nc" id="L72">                .setConnectTimeout(5000)</span>
<span class="nc" id="L73">                .setConnectionRequestTimeout(5000)</span>
<span class="nc" id="L74">                .setSocketTimeout(5000)</span>
<span class="nc" id="L75">                .build();</span>
<span class="nc" id="L76">        client = HttpClientBuilder.create().setDefaultRequestConfig(config).build();</span>
<span class="nc" id="L77">    }</span>

    @Override
    public void invokeOPA(String epUrl, Map&lt;String, Object&gt; payload, Map&lt;String, String&gt; options, Map&lt;String, Object&gt; eventHandlers) {

<span class="nc" id="L82">        JsAuthenticationContext context1 = (JsAuthenticationContext) (payload.get(OPAConstants.CONTEXT));</span>
<span class="nc" id="L83">        JsStep slot = (JsStep) (((JsSteps) context1.getMember(FrameworkConstants.JSAttributes.JS_STEPS)).getSlot(1));</span>
<span class="nc" id="L84">        JsAuthenticatedUser user = (JsAuthenticatedUser) slot.getMember(FrameworkConstants.JSAttributes.JS_AUTHENTICATED_SUBJECT);</span>
<span class="nc" id="L85">        String userStoreDomain = (String) user.getMember(FrameworkConstants.JSAttributes.JS_USER_STORE_DOMAIN);</span>

<span class="nc" id="L87">        JSONObject userClaims = null;</span>
<span class="nc" id="L88">        List&lt;?&gt; roles = new ArrayList&lt;&gt;();</span>

<span class="nc bnc" id="L90" title="All 2 branches missed.">        if (Boolean.parseBoolean(options.get(OPAConstants.SEND_CLAIMS))) {</span>
<span class="nc" id="L91">            userClaims = getClaims(user);</span>
<span class="nc bnc" id="L92" title="All 2 branches missed.">        } else if (Boolean.parseBoolean(options.get(OPAConstants.SEND_ROLES))) {</span>
<span class="nc" id="L93">            roles = getUserRoles(user);</span>
        }

<span class="nc" id="L96">        JSONObject finalUserClaims = userClaims;</span>
<span class="nc" id="L97">        List&lt;?&gt; finalRoles = roles;</span>
<span class="nc" id="L98">        AsyncProcess asyncProcess = new AsyncProcess((context, asyncReturn) -&gt; {</span>
<span class="nc" id="L99">            JSONObject json = null;</span>
            int responseCode;
            String outcome;

<span class="nc" id="L103">            HttpPost request = new HttpPost(epUrl);</span>
            try {
<span class="nc" id="L105">                request.setHeader(ACCEPT, TYPE_APPLICATION_JSON);</span>
<span class="nc" id="L106">                request.setHeader(CONTENT_TYPE, TYPE_APPLICATION_JSON);</span>

<span class="nc" id="L108">                JSONObject finalJsonObject = new JSONObject();</span>
<span class="nc bnc" id="L109" title="All 2 branches missed.">                for (Map.Entry&lt;String, Object&gt; dataElements : payload.entrySet()) {</span>
<span class="nc bnc" id="L110" title="All 2 branches missed.">                    if (dataElements.getValue() != payload.get(OPAConstants.CONTEXT)) {</span>
<span class="nc" id="L111">                        finalJsonObject.put(dataElements.getKey(), dataElements.getValue());</span>
                    }
<span class="nc" id="L113">                }</span>

<span class="nc" id="L115">                JSONObject userJsonObject = new JSONObject();</span>
<span class="nc" id="L116">                JSONObject input = new JSONObject();</span>

<span class="nc" id="L118">                userJsonObject.put(OPAConstants.CLAIMS, finalUserClaims);</span>
<span class="nc" id="L119">                userJsonObject.put(OPAConstants.ROLES, finalRoles);</span>
<span class="nc" id="L120">                userJsonObject.put(OPAConstants.USER_STORE_DOMAIN, userStoreDomain);</span>
<span class="nc" id="L121">                userJsonObject.put(OPAConstants.USER_CONTEXT_DETAILS, getUserDetails(user));</span>
<span class="nc" id="L122">                finalJsonObject.put(OPAConstants.USER_DETAILS, userJsonObject);</span>

<span class="nc" id="L124">                input.put(&quot;input&quot;, finalJsonObject);</span>

<span class="nc" id="L126">                request.setEntity(new StringEntity(input.toJSONString()));</span>

<span class="nc" id="L128">                try (CloseableHttpResponse response = client.execute(request)) {</span>
<span class="nc" id="L129">                    responseCode = response.getStatusLine().getStatusCode();</span>

<span class="nc bnc" id="L131" title="All 2 branches missed.">                    if (responseCode == 200) {</span>
<span class="nc" id="L132">                        outcome = Constants.OUTCOME_SUCCESS;</span>
<span class="nc" id="L133">                        String jsonString = EntityUtils.toString(response.getEntity());</span>
<span class="nc" id="L134">                        JSONParser parser = new JSONParser();</span>
<span class="nc" id="L135">                        json = (JSONObject) parser.parse(jsonString);</span>
<span class="nc" id="L136">                    } else {</span>
<span class="nc" id="L137">                        outcome = Constants.OUTCOME_FAIL;</span>
                    }
<span class="nc bnc" id="L139" title="All 8 branches missed.">                }</span>

<span class="nc" id="L141">            } catch (ConnectTimeoutException e) {</span>
<span class="nc" id="L142">                LOG.error(&quot;Error while waiting to connect to &quot; + epUrl, e);</span>
<span class="nc" id="L143">                outcome = Constants.OUTCOME_TIMEOUT;</span>
<span class="nc" id="L144">            } catch (SocketTimeoutException e) {</span>
<span class="nc" id="L145">                LOG.error(&quot;Error while waiting for data from &quot; + epUrl, e);</span>
<span class="nc" id="L146">                outcome = Constants.OUTCOME_TIMEOUT;</span>
<span class="nc" id="L147">            } catch (IOException e) {</span>
<span class="nc" id="L148">                LOG.error(&quot;Error while calling endpoint. &quot;, e);</span>
<span class="nc" id="L149">                outcome = Constants.OUTCOME_FAIL;</span>
<span class="nc" id="L150">            } catch (ParseException e) {</span>
<span class="nc" id="L151">                LOG.error(&quot;Error while parsing response. &quot;, e);</span>
<span class="nc" id="L152">                outcome = Constants.OUTCOME_FAIL;</span>
<span class="nc" id="L153">            }</span>

<span class="nc bnc" id="L155" title="All 2 branches missed.">            asyncReturn.accept(context, json != null ? json : Collections.emptyMap(), outcome);</span>
<span class="nc" id="L156">        });</span>
<span class="nc" id="L157">        JsGraphBuilder.addLongWaitProcess(asyncProcess, eventHandlers);</span>
<span class="nc" id="L158">    }</span>

    private JSONObject getClaims(JsAuthenticatedUser user) {

<span class="nc" id="L162">        JSONObject claims = new JSONObject();</span>
<span class="nc" id="L163">        String tenantDomain = (String) user.getMember(FrameworkConstants.JSAttributes.JS_TENANT_DOMAIN);</span>

<span class="nc" id="L165">        List&lt;LocalClaim&gt; localClaims = null;</span>
        try {
<span class="nc" id="L167">            localClaims = OPAFunctionsServiceHolder.getInstance().getClaimMetadataManagementService().getLocalClaims(tenantDomain);</span>
<span class="nc" id="L168">        } catch (ClaimMetadataException e) {</span>
<span class="nc" id="L169">            LOG.error(&quot;Error while getting local claims in tenant domain : &quot; + user.getMember(FrameworkConstants.JSAttributes.JS_TENANT_DOMAIN));</span>
<span class="nc" id="L170">        }</span>

<span class="nc bnc" id="L172" title="All 2 branches missed.">        if (localClaims != null) {</span>
<span class="nc bnc" id="L173" title="All 2 branches missed.">            for (LocalClaim localClaim : localClaims) {</span>
<span class="nc" id="L174">                String claimUri = localClaim.getClaimURI();</span>
<span class="nc" id="L175">                JsClaims jsclaims = ((JsClaims) user.getMember(FrameworkConstants.JSAttributes.JS_LOCAL_CLAIMS));</span>
<span class="nc" id="L176">                String claimValue = (String) (jsclaims.getMember(claimUri));</span>
<span class="nc bnc" id="L177" title="All 2 branches missed.">                if (StringUtils.isNotBlank(claimValue)) {</span>
<span class="nc" id="L178">                    claims.put(claimUri, claimValue);</span>
                }
<span class="nc" id="L180">            }</span>
        }
<span class="nc" id="L182">        return claims;</span>
    }

    private JSONObject getUserDetails(JsAuthenticatedUser user) {

<span class="nc" id="L187">        JSONObject uerDetails = new JSONObject();</span>
<span class="nc" id="L188">        String authenticatedSubjectIdentifier = (String) user.getMember(FrameworkConstants.JSAttributes.JS_AUTHENTICATED_SUBJECT_IDENTIFIER);</span>
<span class="nc" id="L189">        uerDetails.put(OPAConstants.JS_AUTHENTICATED_SUBJECT_IDENTIFIER, authenticatedSubjectIdentifier);</span>
<span class="nc" id="L190">        String userName = (String) user.getMember(FrameworkConstants.JSAttributes.JS_USERNAME);</span>
<span class="nc" id="L191">        uerDetails.put(OPAConstants.JS_USERNAME, userName);</span>
<span class="nc" id="L192">        String tenantDomain = (String) user.getMember(FrameworkConstants.JSAttributes.JS_TENANT_DOMAIN);</span>
<span class="nc" id="L193">        uerDetails.put(OPAConstants.JS_TENANT_DOMAIN, tenantDomain);</span>
<span class="nc" id="L194">        return uerDetails;</span>
    }

    private List&lt;?&gt; getUserRoles(JsAuthenticatedUser user) {

<span class="nc" id="L199">        Object userRoles = user.getMember(FrameworkConstants.JSAttributes.JS_LOCAL_ROLES);</span>
<span class="nc" id="L200">        List&lt;?&gt; list = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L201" title="All 2 branches missed.">        if (userRoles.getClass().isArray()) {</span>
<span class="nc" id="L202">            list = Arrays.asList((Object[]) userRoles);</span>
<span class="nc bnc" id="L203" title="All 2 branches missed.">        } else if (userRoles instanceof Collection) {</span>
<span class="nc" id="L204">            list = new ArrayList&lt;&gt;((Collection&lt;?&gt;) userRoles);</span>
        }
<span class="nc" id="L206">        return list;</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.9.201702052155</span></div></body></html>